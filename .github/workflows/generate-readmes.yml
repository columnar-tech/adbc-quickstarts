# Copyright 2026 Columnar Technologies Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Generate README Files

on:
  workflow_dispatch:

  push:
    branches:
      - main
    paths:
      - '.github/data/databases.json'
      - '.github/data/languages.json'
      - '.github/data/root-readme-template.md'
      - '.github/data/language-readme-template.md'
      - '.github/scripts/generate_readmes.py'
      - 'cpp/**'
      - 'go/**'
      - 'java/**'
      - 'python/**'
      - 'r/**'
      - 'rust/**'

jobs:
  generate-readmes:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Generate README files
        run: |
          python .github/scripts/generate_readmes.py --repo-root .

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md cpp/README.md go/README.md java/README.md python/README.md r/README.md rust/README.md

          git commit -m "Auto-generate README files

          Generated by GitHub Actions workflow
          Triggered by: ${{ github.event_name }}
          Source commit: ${{ github.sha }}"

          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## README Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "✅ README files were updated and committed." >> $GITHUB_STEP_SUMMARY
          else
            echo "ℹ️ No changes needed - README files are up to date." >> $GITHUB_STEP_SUMMARY
          fi
